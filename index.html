<html>
  <head>
    <script type="text/javascript" src="./javascripts/jquery.js"></script>
    <script type="text/javascript" src="./javascripts/bin_file_reader.js"></script>
    <script type="text/javascript" src="./javascripts/chunked_file_reader.js"></script>
    <script type="text/javascript" src="./javascripts/fulltext_reader.js"></script>
    <script type="text/javascript" src="./javascripts/hits.js"></script>
    <script type="text/javascript" src="./javascripts/suffixes.js"></script>
    <script type="text/javascript" src="./javascripts/suffix_array_reader.js"></script>
    <script type="text/javascript">
      // These build caches so you don't want to reset them every search
      // If you were clever you would put this into a persistent frame      
      var shardSize = 4;
      var page = 1;
      var perPage = 10;
      var ranking = true;
      var fulltextReader = new FulltextReader("./index/fates/contacts-0000000/fulltext");
      var suffixArrayReader = new SuffixArrayReader(fulltextReader, shardSize, "./index/fates/contacts-0000000/suffixes");
      var hits = null;

      function fulltext_search() {      
        try {        
          var q = $('#search').val();
          var count = suffixArrayReader.count(q);
          $('#results').find('li').remove();
          $('#count').find('span').remove();
          $('#count').append("<span>Total hits: " + count + "</span>");
          $('#count span').fadeIn();
          hits = suffixArrayReader.find(q);
          setTimeout("printResults()", 0);
        } catch(ex) {
          alert(ex + "\n" + ex.stack);
        }          
      }      

      function printResults() {
        var ranking = $('#ranking').is(':checked');
        if (ranking)
          printResultsRanked();
        else
          printResultsUnranked();
      }

      function printResultsUnranked() {
        if (hits && hits.size() > 0) {
          var counter = 1;
          var total = hits.size() > perPage ? perPage : hits.size();
          var start = ((page-1)*perPage);
          for (var i=start; i<start+total; i++) {
            if (i >= hits.size()) break;
            recordData = fulltextReader.hitToRecordData(hits.get(i));
            primaryKey = fulltextReader.getPrimaryKey(recordData);
            fields = fulltextReader.getFields(recordData);
            text = primaryKey + ": " + fields.join(' ');
            $('#results').append("<li id=\"item" + counter + "\" style=\"display:none\">" + text + "</li>");
            $('#item' + counter).fadeIn();
            counter += 1;
          }
        }
      }

      function printResultsRanked() {
        if (hits && hits.size() > 0) {
          // Build a weight table for ranking (for nudging certain fields)
          // firstName, lastName
          var q = $('#search').val();
          var counter = 1;
          var weights = [2000000, 1000000];
          var sorted = fulltextReader.rankOffsets(q, hits, weights, false, page, perPage);
          var total = sorted.length > perPage ? perPage : sorted.length;
          for (var i=0; i<total; i++) {            
            primaryKey = sorted[i][0];
            fields = sorted[i][1];
            score = sorted[i][2];
            text = primaryKey + ": " + fields.join(' ') + " (score " + score + ")";
            $('#results').append("<li id=\"item" + counter + "\" style=\"display:none\">" + text + "</li>");
            $('#item' + counter).fadeIn();
            counter += 1;
          }            
        }      
      }      
    </script>
    <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin:15px;
    }
    #results {
      width: 400px;
      list-style-position: outside;
      list-style-type: none;
      padding:0px;
      margin:0px;
      height:155px;
    }
    #results li {
      margin: 0px;
      padding: 5px;
      background:#efefef;
      border-bottom:1px solid #CCC;
      display:block;
      cursor:pointer;
    }
    #results li:hover {
      background:#FFC;
    }
    -->
    </style>    
  </head>
  <body>
    <p style="width:400px;">This is a quick sample to demonstrate javascript based fulltext searching.
       We have an index of our 50,000 person database accessible to search.
       You can search by name, but currently multi word searching is not enabled.</p>
    <br>
    <form name="search_form" onsubmit="try { fulltext_search(); } finally { return false; }">
      <input name="search" id="search" type="text" />
      <input type="submit" value="Search"/>
      <input type="checkbox" id="ranking" name="ranking"/>
      <label for="ranking">Ranking</label>
    </form>
    <div id="count" style="font-weight:bold"></div><br/>
    <ul id="results">
    </ul>    
  </body>
</html>  
